name: issue-notion-sync

on:
  issues:
    types: [opened, edited, labeled, unlabeled, reopened, closed]

permissions:
  issues: write
  contents: read

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Parse issue metadata
        id: meta
        run: |
          ISSUE_NUMBER=$(jq -r '.issue.number' "$GITHUB_EVENT_PATH")
          ISSUE_TITLE=$(jq -r '.issue.title' "$GITHUB_EVENT_PATH")
          ISSUE_URL=$(jq -r '.issue.html_url' "$GITHUB_EVENT_PATH")
          ISSUE_BODY=$(jq -r '.issue.body // ""' "$GITHUB_EVENT_PATH")
          ISSUE_STATE=$(jq -r '.issue.state' "$GITHUB_EVENT_PATH")
          LABELS=$(jq -r '.issue.labels[].name' "$GITHUB_EVENT_PATH" | tr '\n' ',')

          TYPE="feature"
          [[ "$LABELS" == *"type:bug"* ]] && TYPE="bug"
          [[ "$LABELS" == *"type:chore"* ]] && TYPE="chore"

          STATUS="Todo"
          [[ "$LABELS" == *"status:in-progress"* ]] && STATUS="In Progress"
          [[ "$LABELS" == *"status:qa"* ]] && STATUS="QA"
          [[ "$LABELS" == *"status:done"* ]] && STATUS="Done"
          [[ "$LABELS" == *"status:blocked"* ]] && STATUS="Blocked"
          [[ "$ISSUE_STATE" == "closed" ]] && STATUS="Done"

          PAGE_ID=$(echo "$ISSUE_BODY" | sed -n 's/.*notion_page_id:\s*\([a-zA-Z0-9-]*\).*/\1/p' | head -n1)
          if [ "$PAGE_ID" = "null" ]; then
            PAGE_ID=""
          fi

          echo "issue_number=$ISSUE_NUMBER" >> $GITHUB_OUTPUT
          echo "issue_title<<EOF" >> $GITHUB_OUTPUT
          echo "$ISSUE_TITLE" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "issue_url=$ISSUE_URL" >> $GITHUB_OUTPUT
          echo "type=$TYPE" >> $GITHUB_OUTPUT
          echo "status=$STATUS" >> $GITHUB_OUTPUT
          echo "page_id=$PAGE_ID" >> $GITHUB_OUTPUT

      - name: Upsert Notion page
        id: notion
        env:
          NOTION_TOKEN: ${{ secrets.NOTION_TOKEN }}
          NOTION_DATABASE_ID: ${{ secrets.NOTION_DATABASE_ID }}
        run: |
          set -e
          PAGE_ID="${{ steps.meta.outputs.page_id }}"
          if [ "$PAGE_ID" = "null" ]; then
            PAGE_ID=""
          fi

          PROPS=$(jq -n \
            --arg title "${{ steps.meta.outputs.issue_title }}" \
            --arg issueUrl "${{ steps.meta.outputs.issue_url }}" \
            --argjson issueNum ${{ steps.meta.outputs.issue_number }} \
            --arg type "${{ steps.meta.outputs.type }}" \
            --arg status "${{ steps.meta.outputs.status }}" \
            '{
              Name: { title: [{ text: { content: $title } }] },
              "GitHub Issue URL": { url: $issueUrl },
              "Issue Number": { number: $issueNum },
              Type: { select: { name: $type } },
              Status: { select: { name: $status } }
            }')

          if [ -z "$PAGE_ID" ]; then
            BODY=$(jq -n \
              --arg db "$NOTION_DATABASE_ID" \
              --argjson props "$PROPS" \
              '{ parent: { database_id: $db }, properties: $props }')

            RESP=$(curl -sS -X POST "https://api.notion.com/v1/pages" \
              -H "Authorization: Bearer $NOTION_TOKEN" \
              -H "Content-Type: application/json" \
              -H "Notion-Version: 2022-06-28" \
              -d "$BODY" \
              -w '\n%{http_code}')
            HTTP_CODE=$(echo "$RESP" | tail -n1)
            RESP_BODY=$(echo "$RESP" | sed '$d')
            if [ "$HTTP_CODE" -ge 300 ]; then
              echo "::error::Notion create failed ($HTTP_CODE): $RESP_BODY"
              exit 1
            fi
            NEW_ID=$(echo "$RESP_BODY" | jq -r '.id // empty')
            if [ -z "$NEW_ID" ]; then
              echo "::error::Notion create response missing page id: $RESP_BODY"
              exit 1
            fi
            echo "page_id=$NEW_ID" >> $GITHUB_OUTPUT
          else
            BODY=$(jq -n --argjson props "$PROPS" '{ properties: $props }')
            RESP=$(curl -sS -X PATCH "https://api.notion.com/v1/pages/$PAGE_ID" \
              -H "Authorization: Bearer $NOTION_TOKEN" \
              -H "Content-Type: application/json" \
              -H "Notion-Version: 2022-06-28" \
              -d "$BODY" \
              -w '\n%{http_code}')
            HTTP_CODE=$(echo "$RESP" | tail -n1)
            RESP_BODY=$(echo "$RESP" | sed '$d')
            if [ "$HTTP_CODE" -ge 300 ]; then
              echo "::error::Notion update failed ($HTTP_CODE): $RESP_BODY"
              exit 1
            fi
            echo "page_id=$PAGE_ID" >> $GITHUB_OUTPUT
          fi

      - name: Write Notion marker to issue body
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            const pageId = `${{ steps.notion.outputs.page_id }}`;
            let body = issue.body || "";
            if (body.includes("notion_page_id:")) {
              body = body.replace(/notion_page_id:\s*(?:null|[a-zA-Z0-9-]+)/g, `notion_page_id: ${pageId}`);
            } else {
              body += `\n\n<!-- notion_page_id: ${pageId} -->`;
            }
            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              body
            });
