name: notion-dedup

on:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  dedup:
    runs-on: ubuntu-latest
    steps:
      - name: Remove duplicate non-done rows
        env:
          NOTION_TOKEN: ${{ secrets.NOTION_TOKEN }}
          NOTION_DATABASE_ID: ${{ secrets.NOTION_DATABASE_ID }}
        run: |
          set -euo pipefail

          fetch_page() {
            local cursor="$1"
            local req
            if [ -n "$cursor" ]; then
              req=$(jq -n --arg cursor "$cursor" '{page_size: 100, start_cursor: $cursor}')
            else
              req=$(jq -n '{page_size: 100}')
            fi

            curl -sS -X POST "https://api.notion.com/v1/databases/$NOTION_DATABASE_ID/query" \
              -H "Authorization: Bearer $NOTION_TOKEN" \
              -H "Content-Type: application/json" \
              -H "Notion-Version: 2022-06-28" \
              -d "$req" \
              -w '\n%{http_code}'
          }

          all='[]'
          cursor=''

          while :; do
            resp=$(fetch_page "$cursor")
            http_code=$(echo "$resp" | tail -n1)
            body=$(echo "$resp" | sed '$d')

            if [ "$http_code" -ge 300 ]; then
              echo "::error::Notion query failed ($http_code): $body"
              exit 1
            fi

            all=$(jq -n --argjson a "$all" --argjson b "$(echo "$body" | jq '.results')" '$a + $b')

            has_more=$(echo "$body" | jq -r '.has_more')
            if [ "$has_more" != "true" ]; then
              break
            fi
            cursor=$(echo "$body" | jq -r '.next_cursor // empty')
          done

          targets=$(echo "$all" | jq '[
            group_by(.properties["Issue Number"].number)[]
            | select((.[0].properties["Issue Number"].number != null) and (length > 1))
            | .[]
            | select((.properties.Status.select.name // "") != "Done")
            | {
                id: .id,
                issue: .properties["Issue Number"].number,
                status: (.properties.Status.select.name // "")
              }
          ]')

          count=$(echo "$targets" | jq 'length')
          echo "Found $count duplicate non-done rows to archive"

          if [ "$count" -eq 0 ]; then
            echo "No rows to archive"
            exit 0
          fi

          echo "$targets" | jq -c '.[]' | while read -r row; do
            page_id=$(echo "$row" | jq -r '.id')
            issue_num=$(echo "$row" | jq -r '.issue')
            status=$(echo "$row" | jq -r '.status')

            patch_resp=$(curl -sS -X PATCH "https://api.notion.com/v1/pages/$page_id" \
              -H "Authorization: Bearer $NOTION_TOKEN" \
              -H "Content-Type: application/json" \
              -H "Notion-Version: 2022-06-28" \
              -d '{"archived": true}' \
              -w '\n%{http_code}')

            patch_code=$(echo "$patch_resp" | tail -n1)
            patch_body=$(echo "$patch_resp" | sed '$d')

            if [ "$patch_code" -ge 300 ]; then
              echo "::error::Failed to archive page $page_id (issue $issue_num, status $status): $patch_body"
              exit 1
            fi

            echo "Archived page=$page_id issue=$issue_num status=$status"
          done
